#!/bin/bash

set -e
LANGS=(ruby python javascript rust java scala)

if [[ $# -lt 1 ]]; then
    cat << EOF
Usage: ./bin/build-simplified LANGPACK_NAME [TAG_SUFFIX]
  LANGPACK_NAME must be one of: ${LANGS[@]}
  TAG_SUFFIX if supplied will be appended to the name of the generated images
EOF
    exit 1
fi
ALGO_UID=${ALGO_UID:-$(id -u)}
LANGPACK=$1
TAG_SUFFIX=${2:-empty}

IMAGE_TAG=$LANGPACK
if [[ $TAG_SUFFIX != "empty" ]]; then
    IMAGE_TAG=${IMAGE_TAG}-$TAG_SUFFIX
fi

# First build the new langserver binary if needed
cargo build --release

# Then ensure the base image is up to date
docker build --build-arg ALGO_UID=$ALGO_UID -f docker/simplified/Dockerfile.base -t algorithmia/langpack:base .

# If desired, build the GPU version of the image
if [[ ! -z ${GPU+x} ]]; then
    docker build -f docker/simplified/Dockerfile.base-gpu -t algorithmia/langpack:base-gpu .
    IMAGE_TAG=${LANGPACK}-gpu
    if [[ $TAG_SUFFIX != "empty" ]]; then
        IMAGE_TAG=${IMAGE_TAG}-$TAG_SUFFIX
    fi
    docker build --build-arg LANGPACK=$LANGPACK -f docker/simplified/Dockerfile.langpack-gpu -t algorithmia/langpack-runner:${IMAGE_TAG} .
else
    docker build --build-arg LANGPACK=$LANGPACK -f docker/simplified/Dockerfile.langpack -t algorithmia/langpack-runner:$IMAGE_TAG .
fi
