#!/bin/env ruby

require 'json'
require 'base64'

def pipe_loop
  require_relative "#{Dir.pwd}/src/algorithm.rb" # TODO: would be nice to know algoname
  STDIN.each_line do |line|
    request = JSON.parse(line)
    result = call_algorithm(request)
    File.open('/tmp/algoout', 'w') do |algoout|
      # TODO: figure out how we want to write the result
      algoout.puts(result)
    end
  end
end

def call_algorithm(request)
  parts = request['body'].map do |part|
    case part['content_type']
      when 'text', 'json'
        part['data']
      when 'binary'
        Base64.decode64(part['data'])
      else
        STDERR.puts 'Invalid content_type...' #TODO
        nil
    end
  end
  return apply(*parts)
end

pipe_loop
