FROM {{builder_image}} as builder

# Docker build commands don't resolve environment variables so need this to either be numeric or a build argument
COPY --chown=algo:algo algosource /opt/algorithm/

{% if config.local_dependency_src_path is defined %}
COPY --chown=algo:algo {{config.local_dependency_src_path}} {{config.local_dependency_dest_path}}
{% endif %}

ENV HOME=/home/algo
USER algo
RUN /usr/local/bin/algorithmia-build

FROM {{runner_image}}
{% for artifact in config.artifacts %}
COPY --from=builder --chown=algo:algo {{artifact.source}} {{artifact.destination}}
{% endfor %}
USER algo
WORKDIR /opt/algorithm
ENTRYPOINT /bin/init-langserver
