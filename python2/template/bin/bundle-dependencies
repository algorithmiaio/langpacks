#!/bin/bash

set -e
shopt -s extglob

export PATH=/opt/anaconda2/bin:$PATH

# Touch a file to know what files are new
touch /tmp/start-time
pip install -r requirements.txt

if [[ -d dependencies ]]; then
    echo "Unable to compile due to pre-existing dependencies directory!"
    exit 1
fi
mkdir dependencies

# -maxdepth 1 : Only need to move files or top-level directories
# -mindepth 1  : Don't want to include the site-packages directory (i.e. must be below that)
for f in $(find /opt/anaconda2/lib/python2.7/site-packages -maxdepth 1 -mindepth 1 -newer /tmp/start-time); do
    echo "Adding dependency: $f"
    mv $f dependencies
done

# Some python packages will install binaries, so we also copy over those files
if [[ ! -d dependencies/bin ]]; then
    mkdir dependencies/bin
fi
for f in $(find /opt/anaconda2/bin -maxdepth 1 -mindepth 1 -newer /tmp/start-time); do
    echo "Adding dependency/bin: $f"
    mv $f dependencies/bin
done
  
zip -q -r dependencies.zip dependencies


